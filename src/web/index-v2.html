<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRE | Trading Platform</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&amp;display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="cre-v2.css">
</head>
<body data-theme="dark">
    <!-- HEADER - Clean, minimal -->
    <header class="cre-header">
        <div class="header-left">
            <div class="logo">CRE</div>
            <nav class="nav-tabs">
                <a href="#" class="nav-tab active" data-view="trade">Trade</a>
                <a href="#" class="nav-tab" data-view="markets">Markets</a>
                <a href="#" class="nav-tab" data-view="portfolio">Portfolio</a>
            </nav>
        </div>
        <div class="header-center">
            <div class="market-ticker">
                <span class="ticker-symbol" id="headerSymbol">USD-MNT</span>
                <span class="ticker-price" id="headerPrice">3,450.00</span>
                <span class="ticker-change positive" id="headerChange">+0.12%</span>
            </div>
        </div>
        <div class="header-right">
            <div class="account-balance">
                <span class="balance-label">Equity</span>
                <span class="balance-value" id="headerEquity">0.00 MNT</span>
            </div>
            <div class="theme-toggle">
                <button class="theme-btn" onclick="setTheme('dark')" title="Dark">D</button>
                <button class="theme-btn" onclick="setTheme('light')" title="Light">L</button>
            </div>
            <div class="lang-toggle">
                <button class="lang-btn active" onclick="setLang('en')">EN</button>
                <button class="lang-btn" onclick="setLang('mn')">MN</button>
            </div>
            <button class="header-btn login-btn" id="loginBtn" onclick="showLogin()">Login</button>
        </div>
    </header>

    <!-- MAIN LAYOUT - Three column -->
    <main class="cre-main">
        <!-- LEFT: Watchlist -->
        <aside class="sidebar sidebar-left">
            <div class="sidebar-header">
                <span class="sidebar-title">Markets</span>
                <input type="text" class="search-input" id="marketSearch" placeholder="Search...">
            </div>
            <div class="market-categories">
                <button class="cat-btn active" data-cat="all">All</button>
                <button class="cat-btn" data-cat="fx">FX</button>
                <button class="cat-btn" data-cat="crypto">Crypto</button>
                <button class="cat-btn" data-cat="commodities">Metals</button>
            </div>
            <div class="market-list" id="marketList">
                <!-- Populated by JS -->
            </div>
        </aside>

        <!-- CENTER: Chart + Orderbook -->
        <section class="center-panel">
            <div class="chart-section">
                <div class="chart-header">
                    <div class="chart-info">
                        <span class="chart-symbol" id="chartSymbol">USD-MNT-PERP</span>
                        <span class="chart-price" id="chartPrice">3,450.00</span>
                        <span class="chart-change positive" id="chartChange">+0.12%</span>
                    </div>
                    <div class="chart-tools">
                        <button class="tf-btn active" data-tf="1">1m</button>
                        <button class="tf-btn" data-tf="5">5m</button>
                        <button class="tf-btn" data-tf="15">15m</button>
                        <button class="tf-btn" data-tf="60">1H</button>
                        <button class="tf-btn" data-tf="D">1D</button>
                    </div>
                </div>
                <div class="chart-container" id="chartContainer"></div>
            </div>
            <div class="orderbook-section">
                <div class="orderbook-header">
                    <span class="ob-title">Order Book</span>
                    <div class="ob-controls">
                        <button class="ob-btn active" data-mode="split">Split</button>
                        <button class="ob-btn" data-mode="ladder">Ladder</button>
                    </div>
                </div>
                <div class="orderbook-container">
                    <div class="ob-side ob-bids">
                        <div class="ob-col-header"><span>Price</span><span>Size</span></div>
                        <div class="ob-levels" id="bidLevels"></div>
                    </div>
                    <div class="ob-spread" id="spreadDisplay">Spread: 0.00</div>
                    <div class="ob-side ob-asks">
                        <div class="ob-col-header"><span>Price</span><span>Size</span></div>
                        <div class="ob-levels" id="askLevels"></div>
                    </div>
                </div>
                <div class="recent-trades">
                    <div class="trades-header">Recent Trades</div>
                    <div class="trades-list" id="tradesList"></div>
                </div>
            </div>
        </section>

        <!-- RIGHT: Trade Panel -->
        <aside class="sidebar sidebar-right trade-panel">
            <div class="trade-header">
                <span class="trade-title">Place Order</span>
            </div>
            <div class="order-type-tabs">
                <button class="order-tab active" data-type="market">Market</button>
                <button class="order-tab" data-type="limit">Limit</button>
                <button class="order-tab" data-type="stop">Stop</button>
            </div>
            <div class="side-buttons">
                <button class="side-btn buy active" id="buyBtn">Buy / Long</button>
                <button class="side-btn sell" id="sellBtn">Sell / Short</button>
            </div>
            <div class="order-form">
                <div class="form-group">
                    <label>Quantity</label>
                    <input type="number" class="form-input" id="quantity" value="1" step="0.01">
                    <div class="quick-btns">
                        <button class="quick-btn" data-qty="0.1">0.1</button>
                        <button class="quick-btn" data-qty="0.5">0.5</button>
                        <button class="quick-btn active" data-qty="1">1</button>
                        <button class="quick-btn" data-qty="5">5</button>
                        <button class="quick-btn" data-qty="10">10</button>
                    </div>
                </div>
                <div class="form-group limit-only" style="display:none;">
                    <label>Price</label>
                    <input type="number" class="form-input" id="limitPrice" step="0.01">
                </div>
                <div class="form-group">
                    <label>Leverage</label>
                    <div class="leverage-row">
                        <input type="range" class="leverage-slider" id="leverageSlider" min="1" max="100" value="10">
                        <span class="leverage-value" id="leverageValue">10x</span>
                    </div>
                    <div class="leverage-presets">
                        <button class="lev-btn" data-lev="1">1x</button>
                        <button class="lev-btn" data-lev="5">5x</button>
                        <button class="lev-btn active" data-lev="10">10x</button>
                        <button class="lev-btn" data-lev="25">25x</button>
                        <button class="lev-btn" data-lev="50">50x</button>
                    </div>
                </div>
                <div class="order-summary">
                    <div class="summary-row">
                        <span>Entry Price</span>
                        <span id="entryPrice">-</span>
                    </div>
                    <div class="summary-row">
                        <span>Position Value</span>
                        <span id="posValue">-</span>
                    </div>
                    <div class="summary-row">
                        <span>Required Margin</span>
                        <span id="reqMargin">-</span>
                    </div>
                    <div class="summary-row">
                        <span>Est. Fee</span>
                        <span id="estFee">-</span>
                    </div>
                </div>
                <button class="submit-btn buy" id="submitBtn">Buy USD-MNT-PERP</button>
            </div>
        </aside>
    </main>

    <!-- BOTTOM: Positions/Orders/History -->
    <footer class="cre-footer">
        <div class="footer-tabs">
            <button class="footer-tab active" data-panel="positions">Positions</button>
            <button class="footer-tab" data-panel="orders">Open Orders</button>
            <button class="footer-tab" data-panel="history">Trade History</button>
        </div>
        <div class="footer-panels">
            <div class="footer-panel active" id="panelPositions">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Side</th>
                            <th>Size</th>
                            <th>Entry</th>
                            <th>Mark</th>
                            <th>PnL</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="positionsBody">
                        <tr class="empty-row"><td colspan="7">No open positions</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="footer-panel" id="panelOrders">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Symbol</th>
                            <th>Type</th>
                            <th>Side</th>
                            <th>Price</th>
                            <th>Qty</th>
                            <th>Filled</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ordersBody">
                        <tr class="empty-row"><td colspan="8">No open orders</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="footer-panel" id="panelHistory">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Symbol</th>
                            <th>Side</th>
                            <th>Price</th>
                            <th>Qty</th>
                            <th>Fee</th>
                            <th>PnL</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                        <tr class="empty-row"><td colspan="7">No trade history</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </footer>

    <!-- LOGIN MODAL -->
    <div class="modal-overlay hidden" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">Login to CRE</span>
                <button class="modal-close" onclick="hideLogin()">X</button>
            </div>
            <div class="modal-body">
                <div class="login-step active" id="stepPhone">
                    <label>Phone Number</label>
                    <div class="phone-input-row">
                        <span class="phone-prefix">+976</span>
                        <input type="tel" class="form-input" id="phoneInput" placeholder="99001234" maxlength="8">
                    </div>
                    <button class="modal-btn" id="requestOtpBtn" onclick="requestOtp()">Send Code</button>
                </div>
                <div class="login-step" id="stepOtp">
                    <label>Enter 6-digit code</label>
                    <div class="otp-inputs">
                        <input type="text" class="otp-digit" maxlength="1">
                        <input type="text" class="otp-digit" maxlength="1">
                        <input type="text" class="otp-digit" maxlength="1">
                        <input type="text" class="otp-digit" maxlength="1">
                        <input type="text" class="otp-digit" maxlength="1">
                        <input type="text" class="otp-digit" maxlength="1">
                    </div>
                    <button class="modal-btn" id="verifyOtpBtn" onclick="verifyOtp()">Verify</button>
                    <button class="modal-link" onclick="backToPhone()">Change number</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <script type="module">
        import { Utils } from './modules/utils.js';
        import { State } from './modules/state.js';
        import { Theme } from './modules/theme.js';
        import { Api } from './modules/api.js';
        import { SSE } from './modules/sse.js';
        import { Toast } from './modules/toast.js';
        import { Modal } from './modules/modal.js';
        import { Keyboard } from './modules/keyboard.js';
        import { OrderBook } from './modules/orderbook.js';
        import { Chart } from './modules/chart.js';
        import { Positions } from './modules/positions.js';
        import { Auth } from './modules/auth.js';
        import { Layout } from './modules/layout.js';
        import { Watchlist } from './modules/watchlist.js';
        import { Trade } from './modules/trade.js';
        import { Orders } from './modules/orders.js';
        import { History } from './modules/history.js';
        import { Alerts } from './modules/alerts.js';
        import { Connection } from './modules/connection.js';
        import { I18n } from './modules/i18n.js';
        import { ErrorHandler } from './modules/error-handler.js';
        import { Marketplace } from './modules/marketplace.js';

        // Initialize app
        window.App = {
            Utils, State, Theme, Api, SSE, Toast, Modal, Keyboard,
            OrderBook, Chart, Positions, Auth, Layout, Watchlist,
            Trade, Orders, History, Alerts, Connection, I18n,
            ErrorHandler, Marketplace
        };

        // Global functions for onclick handlers
        window.setTheme = (t) => Theme.set(t);
        window.setLang = (l) => I18n.setLanguage(l);
        window.showLogin = () => Modal.show('loginModal');
        window.hideLogin = () => Modal.hide('loginModal');
        window.requestOtp = () => Auth.requestOtp();
        window.verifyOtp = () => Auth.verifyOtp();
        window.backToPhone = () => Auth.backToPhone();

        // Boot sequence
        document.addEventListener('DOMContentLoaded', async () => {
            Theme.init();
            I18n.init();
            await Api.init();
            SSE.connect();
            Chart.init('chartContainer');
            OrderBook.init();
            Watchlist.init('marketList');
            Trade.init();
            Positions.init();
            Orders.init();
            History.init();
            Keyboard.init();
            Connection.init();

            // Bind UI events
            document.querySelectorAll('.tf-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tf-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    Chart.setTimeframe(btn.dataset.tf);
                });
            });

            document.querySelectorAll('.order-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.order-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    Trade.setOrderType(tab.dataset.type);
                });
            });

            document.querySelectorAll('.footer-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.footer-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    document.querySelectorAll('.footer-panel').forEach(p => p.classList.remove('active'));
                    document.getElementById('panel' + tab.dataset.panel.charAt(0).toUpperCase() + tab.dataset.panel.slice(1))?.classList.add('active');
                });
            });

            document.querySelectorAll('.cat-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    Watchlist.filter(btn.dataset.cat);
                });
            });

            document.getElementById('buyBtn').addEventListener('click', () => Trade.setSide('buy'));
            document.getElementById('sellBtn').addEventListener('click', () => Trade.setSide('sell'));
            document.getElementById('submitBtn').addEventListener('click', () => Trade.submit());

            console.log('[CRE] v2.0 initialized');
        });
    </script>
</body>
</html>
