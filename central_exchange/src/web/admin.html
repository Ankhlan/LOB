<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Central Exchange</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-app: #0d1117;
            --bg-primary: #161b22;
            --bg-secondary: #21262d;
            --bg-tertiary: #30363d;
            --border: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --accent: #58a6ff;
            --green: #3fb950;
            --red: #f85149;
            --yellow: #d29922;
            --purple: #a371f7;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Inter, -apple-system, BlinkMacSystemFont, sans-serif; 
            background: var(--bg-app); 
            color: var(--text-primary);
            min-height: 100vh;
        }
        .mono { font-family: Consolas, 'Courier New', monospace; }
        
        /* Header */
        .admin-header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .admin-title { font-size: 18px; font-weight: 600; }
        .admin-title span { color: var(--accent); }
        .header-actions { display: flex; gap: 12px; align-items: center; }
        .status-badge { 
            padding: 4px 12px; 
            border-radius: 12px; 
            font-size: 11px; 
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .status-badge.online { background: rgba(63, 185, 80, 0.15); color: var(--green); }
        .status-badge.offline { background: rgba(248, 81, 73, 0.15); color: var(--red); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; }
        
        /* Navigation */
        .admin-nav {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            padding: 0 24px;
            display: flex;
            gap: 4px;
        }
        .nav-item {
            padding: 12px 16px;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.15s ease;
        }
        .nav-item:hover { color: var(--text-primary); }
        .nav-item.active { color: var(--accent); border-color: var(--accent); }
        
        /* Main Content */
        .admin-content {
            padding: 24px;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        /* Cards Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
        }
        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .stat-label { color: var(--text-secondary); font-size: 12px; }
        .stat-icon { font-size: 24px; }
        .stat-value { font-size: 28px; font-weight: 600; }
        .stat-change { 
            font-size: 12px; 
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .stat-change.up { color: var(--green); }
        .stat-change.down { color: var(--red); }
        
        /* Tables */
        .panel {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 24px;
            overflow: hidden;
        }
        .panel-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .panel-title { font-size: 14px; font-weight: 600; }
        .panel-actions { display: flex; gap: 8px; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        th {
            text-align: left;
            padding: 12px 16px;
            color: var(--text-muted);
            font-weight: 500;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
        }
        td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            color: var(--text-secondary);
        }
        tr:hover { background: var(--bg-secondary); }
        
        /* Buttons */
        .btn {
            padding: 8px 16px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        .btn:hover { background: var(--bg-tertiary); }
        .btn-primary { background: var(--accent); border-color: var(--accent); color: white; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-danger { background: rgba(248, 81, 73, 0.15); border-color: var(--red); color: var(--red); }
        .btn-danger:hover { background: var(--red); color: white; }
        .btn-success { background: rgba(63, 185, 80, 0.15); border-color: var(--green); color: var(--green); }
        .btn-success:hover { background: var(--green); color: white; }
        .btn-sm { padding: 4px 10px; font-size: 11px; }
        
        /* Badge */
        .badge {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
        }
        .badge-pending { background: rgba(210, 153, 34, 0.15); color: var(--yellow); }
        .badge-approved { background: rgba(63, 185, 80, 0.15); color: var(--green); }
        .badge-rejected { background: rgba(248, 81, 73, 0.15); color: var(--red); }
        
        /* Section */
        .section { display: none; }
        .section.active { display: block; }
        
        /* Circuit Breaker */
        .circuit-card {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .circuit-symbol { font-weight: 600; font-size: 14px; }
        .circuit-state { margin-top: 4px; font-size: 12px; color: var(--text-secondary); }
        .circuit-state.halted { color: var(--red); }
        .circuit-state.normal { color: var(--green); }
        
        /* USD-MNT Panel */
        .rate-display {
            font-size: 36px;
            font-weight: 600;
            text-align: center;
            padding: 24px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .rate-display .currency { font-size: 14px; color: var(--text-muted); margin-right: 8px; }
        
        /* Tabs Content */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }
        
        /* Alert */
        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 13px;
        }
        .alert-info { background: rgba(88, 166, 255, 0.1); border: 1px solid var(--accent); color: var(--accent); }
        .alert-warning { background: rgba(210, 153, 34, 0.1); border: 1px solid var(--yellow); color: var(--yellow); }
        .alert-danger { background: rgba(248, 81, 73, 0.1); border: 1px solid var(--red); color: var(--red); }
    </style>
</head>
<body>
    <header class="admin-header">
        <div class="admin-title">
            <span>CRE.mn</span> Admin Dashboard
        </div>
        <div class="header-actions">
            <div class="status-badge online" id="statusBadge">
                <span class="status-dot"></span>
                <span id="statusText">System Online</span>
            </div>
            <a href="/" class="btn">‚Üê Back to Trading</a>
        </div>
    </header>
    
    <nav class="admin-nav">
        <div class="nav-item active" onclick="showSection('overview')">Overview</div>
        <div class="nav-item" onclick="showSection('users')">Users & KYC</div>
        <div class="nav-item" onclick="showSection('orders')">Orders & Trades</div>
        <div class="nav-item" onclick="showSection('circuits')">Circuit Breakers</div>
        <div class="nav-item" onclick="showSection('usdmnt')">USD/MNT Market</div>
        <div class="nav-item" onclick="showSection('system')">System Tools</div>
    </nav>
    
    <main class="admin-content">
        <!-- Overview Section -->
        <section class="section active" id="sectionOverview">
            <div class="cards-grid">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <span class="stat-label">Total Users</span>
                        <span class="stat-icon">üë•</span>
                    </div>
                    <div class="stat-value" id="totalUsers">-</div>
                    <div class="stat-change up">‚Üë 12% this week</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <span class="stat-label">Pending KYC</span>
                        <span class="stat-icon">üìã</span>
                    </div>
                    <div class="stat-value" id="pendingKyc">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <span class="stat-label">24h Volume</span>
                        <span class="stat-icon">üìä</span>
                    </div>
                    <div class="stat-value mono" id="volume24h">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <span class="stat-label">USD/MNT Rate</span>
                        <span class="stat-icon">üí±</span>
                    </div>
                    <div class="stat-value mono" id="usdmntRate">-</div>
                </div>
            </div>
            
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">Recent Activity</div>
                    <button class="btn btn-sm" onclick="refreshActivity()">Refresh</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Event</th>
                            <th>User</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="activityTable">
                        <tr><td colspan="4" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
        
        <!-- Users Section -->
        <section class="section" id="sectionUsers">
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">Pending KYC Approvals</div>
                    <button class="btn btn-sm" onclick="refreshKyc()">Refresh</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Phone</th>
                            <th>Submitted</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="kycTable">
                        <tr><td colspan="5" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">Pending Withdrawals</div>
                    <button class="btn btn-sm" onclick="refreshWithdrawals()">Refresh</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>User</th>
                            <th>Amount</th>
                            <th>Bank</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="withdrawalsTable">
                        <tr><td colspan="6" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
        
        <!-- Orders Section -->
        <section class="section" id="sectionOrders">
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">Live Order Book Summary</div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Bid Orders</th>
                            <th>Ask Orders</th>
                            <th>Spread</th>
                            <th>Last Trade</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTable">
                        <tr><td colspan="5" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
        
        <!-- Circuit Breakers Section -->
        <section class="section" id="sectionCircuits">
            <div class="alert alert-info">
                Circuit breakers automatically halt trading when prices move outside defined limits.
            </div>
            
            <div style="display: flex; gap: 12px; margin-bottom: 24px;">
                <button class="btn btn-danger" onclick="haltMarket()">üõë HALT ALL TRADING</button>
                <button class="btn btn-success" onclick="resumeMarket()">‚ñ∂Ô∏è RESUME ALL TRADING</button>
            </div>
            
            <div class="cards-grid" id="circuitCards">
                <div class="loading">Loading circuit breaker states...</div>
            </div>
        </section>
        
        <!-- USD/MNT Section -->
        <section class="section" id="sectionUsdmnt">
            <div class="cards-grid">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <span class="stat-label">Current Mid Rate</span>
                    </div>
                    <div class="rate-display">
                        <span class="currency">MNT</span>
                        <span id="usdmntMid">-</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <span class="stat-label">BoM Reference</span>
                    </div>
                    <div class="stat-value mono" id="bomRate">-</div>
                    <div class="stat-change" id="bomDeviation">Deviation: -</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <span class="stat-label">Spread</span>
                    </div>
                    <div class="stat-value mono" id="usdmntSpread">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <span class="stat-label">Price Band</span>
                    </div>
                    <div class="stat-value mono" id="priceBand">-</div>
                </div>
            </div>
            
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">Commercial Bank Rates</div>
                    <button class="btn btn-sm" onclick="refreshBankRates()">Refresh</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Bank</th>
                            <th>Bid (Buy USD)</th>
                            <th>Ask (Sell USD)</th>
                            <th>Spread</th>
                            <th>Updated</th>
                        </tr>
                    </thead>
                    <tbody id="bankRatesTable">
                        <tr><td colspan="5" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">Emergency Rate Override</div>
                </div>
                <div style="padding: 16px;">
                    <div class="alert alert-warning">
                        ‚ö†Ô∏è Use only in emergencies. This will override the automated pricing.
                    </div>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <input type="number" id="emergencyRate" placeholder="Enter MNT rate (e.g., 3450)" 
                               style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary); width: 200px;">
                        <button class="btn btn-danger" onclick="setEmergencyRate()">Set Emergency Rate</button>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- System Tools Section -->
        <section class="section" id="sectionSystem">
            <div class="cards-grid">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <span class="stat-label">Server Uptime</span>
                        <span class="stat-icon">‚è±Ô∏è</span>
                    </div>
                    <div class="stat-value mono" id="uptime">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <span class="stat-label">FXCM Status</span>
                        <span class="stat-icon">üì°</span>
                    </div>
                    <div class="stat-value" id="fxcmStatus">-</div>
                </div>
            </div>
            
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">System Tools</div>
                </div>
                <div style="padding: 16px; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px;">
                    <button class="btn" onclick="purgeCandles()">üïØÔ∏è Purge Candle Data</button>
                    <button class="btn" onclick="refreshProducts()">üì¶ Refresh Product Catalog</button>
                    <button class="btn" onclick="testFxcm()">üîå Test FXCM Connection</button>
                    <button class="btn btn-danger" onclick="if(confirm('Are you sure?')) location.reload()">üîÑ Reload Dashboard</button>
                </div>
            </div>
            
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">Balance Sheet</div>
                    <button class="btn btn-sm" onclick="refreshBalanceSheet()">Refresh</button>
                </div>
                <div style="padding: 16px;" id="balanceSheet">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </section>
    </main>
    
    <script>
        const ADMIN_KEY = localStorage.getItem('adminKey') || prompt('Enter Admin API Key:');
        if (ADMIN_KEY) localStorage.setItem('adminKey', ADMIN_KEY);
        
        const headers = { 'X-Admin-Key': ADMIN_KEY };
        
        function showSection(name) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('section' + name.charAt(0).toUpperCase() + name.slice(1)).classList.add('active');
            event.target.classList.add('active');
            
            // Load data for section
            switch(name) {
                case 'users': refreshKyc(); refreshWithdrawals(); break;
                case 'circuits': refreshCircuits(); break;
                case 'usdmnt': refreshUsdmnt(); refreshBankRates(); break;
                case 'system': refreshSystem(); break;
            }
        }
        
        async function api(endpoint, method = 'GET', body = null) {
            const opts = { method, headers: { ...headers, 'Content-Type': 'application/json' } };
            if (body) opts.body = JSON.stringify(body);
            const res = await fetch(endpoint, opts);
            return res.json();
        }
        
        function fmt(n) {
            return new Intl.NumberFormat().format(n);
        }
        
        // Overview
        async function refreshOverview() {
            try {
                const stats = await api('/api/admin/stats');
                document.getElementById('totalUsers').textContent = stats.total_users || 0;
                
                const kyc = await api('/api/admin/kyc/pending');
                document.getElementById('pendingKyc').textContent = (kyc.pending || []).length;
                
                const health = await api('/api/health');
                document.getElementById('volume24h').textContent = fmt(stats.volume_24h || 0) + ' MNT';
            } catch (e) {
                console.error('Failed to load overview:', e);
            }
        }
        
        // KYC
        async function refreshKyc() {
            try {
                const data = await api('/api/admin/kyc/pending');
                const tbody = document.getElementById('kycTable');
                if (!data.pending || data.pending.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-muted);">No pending KYC requests</td></tr>';
                    return;
                }
                tbody.innerHTML = data.pending.map(u => `
                    <tr>
                        <td class="mono">${u.user_id}</td>
                        <td>${u.phone}</td>
                        <td>${u.submitted_at || '-'}</td>
                        <td><span class="badge badge-pending">Pending</span></td>
                        <td>
                            <button class="btn btn-success btn-sm" onclick="approveKyc('${u.user_id}')">Approve</button>
                            <button class="btn btn-danger btn-sm" onclick="rejectKyc('${u.user_id}')">Reject</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                document.getElementById('kycTable').innerHTML = '<tr><td colspan="5">Error loading</td></tr>';
            }
        }
        
        async function approveKyc(userId) {
            await api('/api/admin/kyc/approve', 'POST', { user_id: userId });
            refreshKyc();
        }
        
        async function rejectKyc(userId) {
            const reason = prompt('Rejection reason:');
            if (reason) {
                await api('/api/admin/kyc/reject', 'POST', { user_id: userId, reason });
                refreshKyc();
            }
        }
        
        // Withdrawals
        async function refreshWithdrawals() {
            try {
                const data = await api('/api/admin/withdrawals/pending');
                const tbody = document.getElementById('withdrawalsTable');
                if (!data.pending || data.pending.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-muted);">No pending withdrawals</td></tr>';
                    return;
                }
                tbody.innerHTML = data.pending.map(w => `
                    <tr>
                        <td class="mono">${w.id}</td>
                        <td>${w.user_id}</td>
                        <td class="mono">${fmt(w.amount)} MNT</td>
                        <td>${w.bank || '-'}</td>
                        <td><span class="badge badge-pending">Pending</span></td>
                        <td>
                            <button class="btn btn-success btn-sm" onclick="approveWithdraw('${w.id}')">Approve</button>
                            <button class="btn btn-danger btn-sm" onclick="rejectWithdraw('${w.id}')">Reject</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                document.getElementById('withdrawalsTable').innerHTML = '<tr><td colspan="6">Error loading</td></tr>';
            }
        }
        
        async function approveWithdraw(id) {
            await api(`/api/admin/withdraw/approve/${id}`, 'POST');
            refreshWithdrawals();
        }
        
        async function rejectWithdraw(id) {
            const reason = prompt('Rejection reason:');
            if (reason) {
                await api(`/api/admin/withdraw/reject/${id}`, 'POST', { reason });
                refreshWithdrawals();
            }
        }
        
        // Circuit Breakers
        async function refreshCircuits() {
            try {
                const data = await api('/api/admin/circuit-breakers');
                const container = document.getElementById('circuitCards');
                container.innerHTML = data.symbols.map(s => `
                    <div class="circuit-card">
                        <div>
                            <div class="circuit-symbol">${s.symbol}</div>
                            <div class="circuit-state ${s.state === 'Normal' ? 'normal' : 'halted'}">${s.state}</div>
                        </div>
                        <div>
                            ${s.state === 'Normal' 
                                ? `<button class="btn btn-danger btn-sm" onclick="haltSymbol('${s.symbol}')">Halt</button>`
                                : `<button class="btn btn-success btn-sm" onclick="resumeSymbol('${s.symbol}')">Resume</button>`
                            }
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                document.getElementById('circuitCards').innerHTML = '<div>Error loading circuit breakers</div>';
            }
        }
        
        async function haltSymbol(symbol) {
            await api(`/api/admin/halt/${symbol}`, 'POST');
            refreshCircuits();
        }
        
        async function resumeSymbol(symbol) {
            await api(`/api/admin/resume/${symbol}`, 'POST');
            refreshCircuits();
        }
        
        async function haltMarket() {
            if (confirm('HALT ALL TRADING? This will stop all order matching.')) {
                await api('/api/admin/halt-market', 'POST');
                refreshCircuits();
                alert('Market halted');
            }
        }
        
        async function resumeMarket() {
            await api('/api/admin/resume-market', 'POST');
            refreshCircuits();
            alert('Market resumed');
        }
        
        // USD/MNT
        async function refreshUsdmnt() {
            try {
                const data = await api('/api/admin/usdmnt/metrics');
                document.getElementById('usdmntMid').textContent = fmt(((data.current_bid + data.current_ask) / 2).toFixed(2));
                document.getElementById('bomRate').textContent = fmt(data.bom_rate) + ' MNT';
                document.getElementById('bomDeviation').textContent = 'Deviation: ' + (data.deviation_from_bom_pct || 0).toFixed(3) + '%';
                document.getElementById('usdmntSpread').textContent = (data.spread_pct * 100).toFixed(3) + '%';
                document.getElementById('priceBand').textContent = fmt(data.price_band?.lower) + ' - ' + fmt(data.price_band?.upper);
                document.getElementById('usdmntRate').textContent = fmt(data.current_bid?.toFixed(0) || '-');
            } catch (e) {
                console.error('Failed to load USD/MNT:', e);
            }
        }
        
        async function refreshBankRates() {
            try {
                const data = await api('/api/admin/usdmnt/bank-rates');
                const tbody = document.getElementById('bankRatesTable');
                tbody.innerHTML = data.banks.map(b => `
                    <tr>
                        <td>${b.name}</td>
                        <td class="mono">${fmt(b.bid)}</td>
                        <td class="mono">${fmt(b.ask)}</td>
                        <td class="mono">${(b.spread_pct * 100).toFixed(2)}%</td>
                        <td>${b.updated || 'Real-time'}</td>
                    </tr>
                `).join('');
            } catch (e) {
                document.getElementById('bankRatesTable').innerHTML = '<tr><td colspan="5">Error loading bank rates</td></tr>';
            }
        }
        
        async function setEmergencyRate() {
            const rate = parseFloat(document.getElementById('emergencyRate').value);
            if (!rate || rate < 1000 || rate > 10000) {
                alert('Invalid rate. Must be between 1000-10000 MNT');
                return;
            }
            if (confirm(`Set emergency USD/MNT rate to ${rate}?`)) {
                await api('/api/admin/usdmnt/emergency-rate', 'POST', { rate });
                refreshUsdmnt();
                alert('Emergency rate set');
            }
        }
        
        // System
        async function refreshSystem() {
            try {
                const health = await api('/api/health');
                const hours = Math.floor(health.uptime_seconds / 3600);
                const mins = Math.floor((health.uptime_seconds % 3600) / 60);
                document.getElementById('uptime').textContent = `${hours}h ${mins}m`;
                document.getElementById('fxcmStatus').textContent = health.fxcm_connected ? 'Connected ‚úì' : 'Disconnected ‚úó';
            } catch (e) {
                document.getElementById('statusBadge').className = 'status-badge offline';
                document.getElementById('statusText').textContent = 'System Offline';
            }
        }
        
        async function purgeCandles() {
            if (confirm('Purge all candle data? Historical charts will be regenerated.')) {
                await api('/api/admin/candles/purge', 'POST');
                alert('Candle data purged. Charts will reseed on next load.');
            }
        }
        
        async function refreshBalanceSheet() {
            try {
                const data = await api('/api/admin/balance-sheet');
                document.getElementById('balanceSheet').innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                        <div>
                            <h4 style="margin-bottom: 12px; color: var(--green);">Assets</h4>
                            <div style="font-family: monospace; white-space: pre;">${data.assets || 'No data'}</div>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 12px; color: var(--red);">Liabilities</h4>
                            <div style="font-family: monospace; white-space: pre;">${data.liabilities || 'No data'}</div>
                        </div>
                    </div>
                `;
            } catch (e) {
                document.getElementById('balanceSheet').innerHTML = '<div>Error loading balance sheet</div>';
            }
        }
        
        // Initial load
        refreshOverview();
        refreshSystem();
        
        // Auto-refresh
        setInterval(refreshOverview, 30000);
        setInterval(refreshSystem, 10000);
    </script>
</body>
</html>
